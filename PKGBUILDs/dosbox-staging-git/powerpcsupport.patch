From fa5108a330882de5607435d10cae9c14d524448e Mon Sep 17 00:00:00 2001
From: Link <link4electronics@gmail.com>
Date: Tue, 11 Nov 2025 14:31:41 -0300
Subject: [PATCH 1/3] Compile for powerpc support

---
 CMakeLists.txt      | 12 ++++++++++++
 meson.build         | 34 ++++++++++++++++++++++++++++------
 src/cpu/meson.build |  2 +-
 3 files changed, 41 insertions(+), 7 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 9b793439569..e51b342597d 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -236,6 +236,18 @@ elseif (CMAKE_SYSTEM_PROCESSOR  STREQUAL "arm64"   OR
   set(C_FPU_X86          OFF)
   set(C_UNALIGNED_MEMORY OFF)
 
+elseif (CMAKE_SYSTEM_PROCESSOR  STREQUAL "powerpc64"   OR
+        CMAKE_SYSTEM_PROCESSOR  STREQUAL "powerpc64le"   OR
+        CMAKE_SYSTEM_PROCESSOR  STREQUAL "ppc64"   OR
+        CMAKE_SYSTEM_PROCESSOR  STREQUAL "ppc64le" OR
+        CMAKE_OSX_ARCHITECTURES STREQUAL "ppc64")
+
+   set(C_TARGETCPU        "PPC64")
+   set(C_DYNAMIC_X86      OFF)
+   set(C_DYNREC           ON)
+   set(C_FPU_X86          OFF)
+   set(C_UNALIGNED_MEMORY ON)
+
 else()
   message(FATAL_ERROR "Unknown processor ${CMAKE_SYSTEM_PROCESSOR}")
 endif()
diff --git a/meson.build b/meson.build
index b195c8fa799..2a3de00b371 100644
--- a/meson.build
+++ b/meson.build
@@ -82,6 +82,7 @@ os_family_name = {
     'dragonfly': 'BSD',
 }.get(host_machine.system(), 'UNKNOWN_OS')
 
+host_cpu_family = host_machine.cpu_family()
 
 # Gather compiler settings
 # ~~~~~~~~~~~~~~~~~~~~~~~~
@@ -260,13 +261,17 @@ endif
 if get_option('autovec_info')
     # At least O2 is needed enable auto-vectorizion
     extra_flags += [
-        '-march=native',
         '-O2',
         '-Wno-system-headers',
         '-Rpass-analysis=loop-vectorize',
         '-fopt-info-vec-missed',
         '-fopt-info-vec',
     ]
+    if host_cpu_family == 'powerpc64' or host_cpu_family == 'ppc64'
+            extra_flags += ['-mcpu=native']
+    else
+            extra_flags += ['-march=native']
+    endif
 endif
 
 # Tag BSD executables with the WX-needed bit
@@ -290,12 +295,29 @@ simd_instruction_sets = []
 
 zlib_ng_options = get_option('use_zlib_ng')
 zlib_ng_wants_native = zlib_ng_options.contains('native')
-zlib_ng_is_native = zlib_ng_wants_native and cc.has_argument('-march=native')
+if zlib_ng_wants_native and cc.has_argument('-march=native')
+    zlib_ng_is_native = true
+    if is_optimized_buildtype and zlib_ng_is_native
+        extra_flags += '-march=native'
+        simd_instruction_sets += 'native'
+        message('Enabling native SIMD optimizations')
+    endif
+else
+zlib_ng_wants_native and cc.has_argument('-mcpu=native')
+    zlib_ng_is_native = true
+    if is_optimized_buildtype and zlib_ng_is_native
+        extra_flags += '-mcpu=native'
+        simd_instruction_sets += 'native'
+        message('Enabling native SIMD optimizations')
+    endif
+endif
 
-if is_optimized_buildtype and zlib_ng_is_native
-    extra_flags += '-march=native'
-    simd_instruction_sets += 'native'
-    message('Enabling native SIMD optimizations')
+# ALTIVEC on PowerPC64
+# ~~~~~~~~~~~~~~~
+if target_machine.cpu_family() == 'ppc64'
+    zlib_ng_options += 'altivec'
+    simd_instruction_sets += 'ALTIVEC'
+    message('Using the ALTIVEC instruction set')
 endif
 
 # NEON on Aarch64
diff --git a/src/cpu/meson.build b/src/cpu/meson.build
index dd045d53abe..dfa2f98b99d 100644
--- a/src/cpu/meson.build
+++ b/src/cpu/meson.build
@@ -95,7 +95,7 @@ libcpu = static_library(
         tracy_dep,
         libloguru_dep,
     ],
-    cpp_args: warnings,
+    cpp_args: [ warnings, '-fpermissive' ]
 )
 
 libcpu_dep = declare_dependency(link_with: libcpu)

From 9a6399a502dfa6a7cde20a46ff26ddb6dbc4f4b1 Mon Sep 17 00:00:00 2001
From: Link4Electronics <link4electronics@gmail.com>
Date: Tue, 11 Nov 2025 16:49:20 -0300
Subject: [PATCH 2/3] Better patch

---
 meson.build | 27 ++++++---------------------
 1 file changed, 6 insertions(+), 21 deletions(-)

diff --git a/meson.build b/meson.build
index 2a3de00b371..8abb771758c 100644
--- a/meson.build
+++ b/meson.build
@@ -82,7 +82,6 @@ os_family_name = {
     'dragonfly': 'BSD',
 }.get(host_machine.system(), 'UNKNOWN_OS')
 
-host_cpu_family = host_machine.cpu_family()
 
 # Gather compiler settings
 # ~~~~~~~~~~~~~~~~~~~~~~~~
@@ -261,17 +260,13 @@ endif
 if get_option('autovec_info')
     # At least O2 is needed enable auto-vectorizion
     extra_flags += [
+        '-march=native',
         '-O2',
         '-Wno-system-headers',
         '-Rpass-analysis=loop-vectorize',
         '-fopt-info-vec-missed',
         '-fopt-info-vec',
     ]
-    if host_cpu_family == 'powerpc64' or host_cpu_family == 'ppc64'
-            extra_flags += ['-mcpu=native']
-    else
-            extra_flags += ['-march=native']
-    endif
 endif
 
 # Tag BSD executables with the WX-needed bit
@@ -295,21 +290,11 @@ simd_instruction_sets = []
 
 zlib_ng_options = get_option('use_zlib_ng')
 zlib_ng_wants_native = zlib_ng_options.contains('native')
-if zlib_ng_wants_native and cc.has_argument('-march=native')
-    zlib_ng_is_native = true
-    if is_optimized_buildtype and zlib_ng_is_native
-        extra_flags += '-march=native'
-        simd_instruction_sets += 'native'
-        message('Enabling native SIMD optimizations')
-    endif
-else
-zlib_ng_wants_native and cc.has_argument('-mcpu=native')
-    zlib_ng_is_native = true
-    if is_optimized_buildtype and zlib_ng_is_native
-        extra_flags += '-mcpu=native'
-        simd_instruction_sets += 'native'
-        message('Enabling native SIMD optimizations')
-    endif
+zlib_ng_wants_native and cc.has_argument('-march=native')
+if is_optimized_buildtype and zlib_ng_is_native
+    extra_flags += '-march=native'
+    simd_instruction_sets += 'native'
+    message('Enabling native SIMD optimizations')
 endif
 
 # ALTIVEC on PowerPC64

From 5a881a974760fd69651fc6226e590d405aff2e57 Mon Sep 17 00:00:00 2001
From: Link4Electronics <link4electronics@gmail.com>
Date: Tue, 11 Nov 2025 16:50:08 -0300
Subject: [PATCH 3/3] ops

---
 meson.build | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/meson.build b/meson.build
index 8abb771758c..75f4a9d9121 100644
--- a/meson.build
+++ b/meson.build
@@ -290,7 +290,8 @@ simd_instruction_sets = []
 
 zlib_ng_options = get_option('use_zlib_ng')
 zlib_ng_wants_native = zlib_ng_options.contains('native')
-zlib_ng_wants_native and cc.has_argument('-march=native')
+zlib_ng_is_native = zlib_ng_wants_native and cc.has_argument('-march=native')
+
 if is_optimized_buildtype and zlib_ng_is_native
     extra_flags += '-march=native'
     simd_instruction_sets += 'native'
